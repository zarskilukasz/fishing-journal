name: Pull Request CI

on:
  pull_request:
    branches: [main, develop]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: "22"
  PNPM_VERSION: "9"

jobs:
  # ============================================================================
  # LINT - Code quality check
  # ============================================================================
  lint:
    name: ğŸ” Lint
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      - name: ğŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ” Run ESLint
        run: pnpm lint

  # ============================================================================
  # UNIT TEST - Vitest with coverage
  # ============================================================================
  unit-test:
    name: ğŸ§ª Unit Tests
    runs-on: ubuntu-latest
    needs: [lint]
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      - name: ğŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ§ª Run unit tests with coverage
        run: pnpm test:coverage

      - name: ğŸ“Š Upload unit test coverage
        uses: actions/upload-artifact@v4
        with:
          name: unit-coverage
          path: coverage/
          retention-days: 7

  # ============================================================================
  # E2E TEST - Playwright with coverage
  # ============================================================================
  e2e-test:
    name: ğŸ­ E2E Tests
    runs-on: ubuntu-latest
    needs: [lint]
    environment: integration
    env:
      PUBLIC_SUPABASE_URL: ${{ secrets.PUBLIC_SUPABASE_URL }}
      PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.PUBLIC_SUPABASE_ANON_KEY }}
      ACCUWEATHER_API_KEY: ${{ secrets.ACCUWEATHER_API_KEY }}
      PUBLIC_GOOGLE_MAPS_API_KEY: ${{ secrets.PUBLIC_GOOGLE_MAPS_API_KEY }}
      TEST_USER_EMAIL: ${{ secrets.TEST_USER_EMAIL }}
      TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      - name: ğŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ­ Install Playwright browsers
        run: pnpm exec playwright install --with-deps chromium firefox webkit

      - name: ğŸ—ï¸ Build application
        run: pnpm build

      - name: ğŸ­ Run E2E tests
        run: pnpm test:e2e

      - name: ğŸ“Š Upload E2E test report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7

      - name: ğŸ“¸ Upload E2E test screenshots
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-screenshots
          path: test-results/
          retention-days: 7

  # ============================================================================
  # STATUS COMMENT - Summary comment on PR
  # ============================================================================
  status-comment:
    name: ğŸ’¬ Status Comment
    runs-on: ubuntu-latest
    needs: [lint, unit-test, e2e-test]
    if: success()
    permissions:
      pull-requests: write
    steps:
      - name: ğŸ“¥ Download unit test coverage
        uses: actions/download-artifact@v4
        with:
          name: unit-coverage
          path: coverage/

      - name: ğŸ“¥ Download E2E test report
        uses: actions/download-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/

      - name: ğŸ“Š Parse coverage results
        id: coverage
        run: |
          # Parse unit test coverage from JSON
          if [ -f "coverage/coverage-summary.json" ]; then
            UNIT_LINES=$(jq -r '.total.lines.pct // 0' coverage/coverage-summary.json)
            UNIT_BRANCHES=$(jq -r '.total.branches.pct // 0' coverage/coverage-summary.json)
            UNIT_FUNCTIONS=$(jq -r '.total.functions.pct // 0' coverage/coverage-summary.json)
            UNIT_STATEMENTS=$(jq -r '.total.statements.pct // 0' coverage/coverage-summary.json)
          else
            UNIT_LINES="N/A"
            UNIT_BRANCHES="N/A"
            UNIT_FUNCTIONS="N/A"
            UNIT_STATEMENTS="N/A"
          fi
          
          echo "unit_lines=$UNIT_LINES" >> $GITHUB_OUTPUT
          echo "unit_branches=$UNIT_BRANCHES" >> $GITHUB_OUTPUT
          echo "unit_functions=$UNIT_FUNCTIONS" >> $GITHUB_OUTPUT
          echo "unit_statements=$UNIT_STATEMENTS" >> $GITHUB_OUTPUT

          # Parse E2E test results from Playwright JSON
          if [ -f "playwright-report/results.json" ]; then
            E2E_PASSED=$(jq '[.suites[].specs[].tests[] | select(.status == "expected")] | length' playwright-report/results.json 2>/dev/null || echo "0")
            E2E_FAILED=$(jq '[.suites[].specs[].tests[] | select(.status == "unexpected")] | length' playwright-report/results.json 2>/dev/null || echo "0")
            E2E_SKIPPED=$(jq '[.suites[].specs[].tests[] | select(.status == "skipped")] | length' playwright-report/results.json 2>/dev/null || echo "0")
          else
            E2E_PASSED="N/A"
            E2E_FAILED="N/A"
            E2E_SKIPPED="N/A"
          fi
          
          echo "e2e_passed=$E2E_PASSED" >> $GITHUB_OUTPUT
          echo "e2e_failed=$E2E_FAILED" >> $GITHUB_OUTPUT
          echo "e2e_skipped=$E2E_SKIPPED" >> $GITHUB_OUTPUT

      - name: ğŸ’¬ Create PR comment
        uses: actions/github-script@v7
        with:
          script: |
            const coverage = {
              lines: '${{ steps.coverage.outputs.unit_lines }}',
              branches: '${{ steps.coverage.outputs.unit_branches }}',
              functions: '${{ steps.coverage.outputs.unit_functions }}',
              statements: '${{ steps.coverage.outputs.unit_statements }}'
            };
            
            const e2e = {
              passed: '${{ steps.coverage.outputs.e2e_passed }}',
              failed: '${{ steps.coverage.outputs.e2e_failed }}',
              skipped: '${{ steps.coverage.outputs.e2e_skipped }}'
            };

            const getEmoji = (value) => {
              if (value === 'N/A') return 'âšª';
              const num = parseFloat(value);
              if (num >= 80) return 'ğŸŸ¢';
              if (num >= 60) return 'ğŸŸ¡';
              return 'ğŸ”´';
            };

            const comment = `## âœ… CI Pipeline Passed

            ### ğŸ§ª Unit Test Coverage

            | Metric | Coverage |
            |--------|----------|
            | ${getEmoji(coverage.lines)} Lines | ${coverage.lines}% |
            | ${getEmoji(coverage.branches)} Branches | ${coverage.branches}% |
            | ${getEmoji(coverage.functions)} Functions | ${coverage.functions}% |
            | ${getEmoji(coverage.statements)} Statements | ${coverage.statements}% |

            ### ğŸ­ E2E Test Results

            | Status | Count |
            |--------|-------|
            | âœ… Passed | ${e2e.passed} |
            | âŒ Failed | ${e2e.failed} |
            | â­ï¸ Skipped | ${e2e.skipped} |

            ---
            
            <details>
            <summary>ğŸ“¦ Artifacts</summary>

            - **Unit Coverage Report**: Download from Actions artifacts
            - **Playwright Report**: Download from Actions artifacts

            </details>

            ---
            *Generated by CI Pipeline â€¢ Run ID: ${{ github.run_id }}*
            `;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('CI Pipeline')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

